parameters:
  manualTriggerVersion: ''
  packageVersionVariableName: 'PackageVersion'
  formatByBuildReason: {}

steps:
- bash: |
    if [ -z "$MANUAL_TRIGGER_VERSION" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"manualTriggerVersion\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$PACKAGE_VERSION_VAR" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"packageVersionVariableName\""
      echo "##vso[task.complete result=Failed;]"
    fi
  env:
    MANUAL_TRIGGER_VERSION: ${{ parameters.manualTriggerVersion }}
    PACKAGE_VERSION_VAR: ${{ parameters.packageVersionVariableName }}
  displayName: Check for required parameters in YAML template
- powershell: |
    $packageVersion = '';

    Write-Host "Package manual trigger version = ${{ parameters.manualTriggerVersion }}"
    Write-Host "Build reason = $(Build.Reason)"

    $formats = ${{ parameters.formatByBuildReason }}

    $format = 
      $formats | 
        Where-Object { 
          if ($_.reason -eq $(Build.Reason)) {
            Write-Host "Overriding package version given it's a $(Build.Reason)"
            return true;
          } else { return false } } | 
        Select -First 1

    if ($format.Count -eq 0) {
      $packageVersion = '$(Build.BuildNumber)-${{ parameters.manualTriggerVersion }}'
    } else {
      $packageVersion = $format[0]
    }

    Write-Host "Package version = $packageVersion"
    Write-Host "##vso[task.setvariable variable=${{ parameters.packageVersionVariableName }}]$packageVersion"

    $isFork = $Env:SYSTEM_PULLREQUEST_ISFORK
    Write-Host "Is this a fork? $isFork"
    if($isFork -eq $false) {
        Write-Host "##vso[build.updatebuildnumber]$packageVersion"
    } else {
        # Details: https://developercommunity.visualstudio.com/content/problem/350007/build-from-github-pr-fork-error-tf400813-the-user-1.html
        Write-Host "Not changing the build number as this is not supported for forks for now."
    }
  displayName: 'Determine Package Version in PR'